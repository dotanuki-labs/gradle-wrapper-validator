# Copyright 2024 Dotanuki Labs
# SPDX-License-Identifier: MIT

name: CD

on: workflow_dispatch

jobs:
  publish:
    runs-on: ubuntu-22.04

    steps:
      - name: Project Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6

      - name: Install asdf
        uses: asdf-vm/actions/setup@05e0d2ed97b598bfce82fd30daf324ae0c4570e6 # v3.0.2

      - name: Install required tooling
        run: ./scripts/install-requirements.sh

      - name: Setup Rust and Cargo plugins
        run: just setup

      - name: Check supply-chain issues
        run: just security

      - name: Build against all supported targets
        run: just assemble

      - name: Prepare to release
        id: prepare-release
        run: ./scripts/prepare-release.sh

      - name: Publish on crates.io
        run: cargo publish --token ${{ secrets.CRATESIO_PUBLISH_TOKEN }}

      - name: Publish draft Github release
        uses: softprops/action-gh-release@69320dbe05506a9a39fc8ae11030b214ec2d1f87 # v2.0.5
        with:
          name: ${{ steps.prepare-release.outputs.version }}
          tag_name: ${{ steps.prepare-release.outputs.version }}
          token: ${{ secrets.DOTANUKI_BOT_TOKEN }}
          generate_release_notes: true
          draft: true
          files: |
            target/ci/**/*
            gwv.cdx.json
